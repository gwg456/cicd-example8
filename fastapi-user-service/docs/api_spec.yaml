openapi: 3.1.0
info:
  title: FastAPIç”¨æˆ·æœåŠ¡
  description: |
    åŸºäºFastAPIæ„å»ºçš„ç°ä»£åŒ–ç”¨æˆ·ç®¡ç†æœåŠ¡ï¼Œæä¾›ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€JWTè®¤è¯ç­‰å®Œæ•´åŠŸèƒ½ã€‚
    
    ## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
    
    - **ç”¨æˆ·æ³¨å†Œ**: å®‰å…¨çš„ç”¨æˆ·æ³¨å†Œæ¥å£
    - **ç”¨æˆ·ç™»å½•**: JWT Tokenè®¤è¯ç™»å½•
    - **å¯†ç åŠ å¯†**: bcryptå®‰å…¨å¯†ç å“ˆå¸Œ
    - **JWTè®¤è¯**: å®Œæ•´çš„Tokenè®¤è¯ä½“ç³»
    - **æ•°æ®éªŒè¯**: Pydanticæ¨¡å‹éªŒè¯
    - **APIæ–‡æ¡£**: è‡ªåŠ¨ç”ŸæˆOpenAPIæ–‡æ¡£
    
    ## ğŸ” å®‰å…¨ç‰¹æ€§
    
    - å¯†ç å¼ºåº¦éªŒè¯
    - JWT Tokenè®¤è¯
    - è´¦æˆ·é”å®šæœºåˆ¶
    - ç™»å½•æ—¥å¿—è®°å½•
    - æ•æ„Ÿä¿¡æ¯ä¿æŠ¤
    
    ## ğŸ“– ä½¿ç”¨æŒ‡å—
    
    1. **æ³¨å†Œè´¦æˆ·**: ä½¿ç”¨ `POST /user/register` åˆ›å»ºæ–°ç”¨æˆ·
    2. **ç”¨æˆ·ç™»å½•**: ä½¿ç”¨ `POST /user/login` è·å–JWT Token
    3. **è®¤è¯è¯·æ±‚**: åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ  `Authorization: Bearer <token>`
    4. **ç®¡ç†ç”¨æˆ·**: ç®¡ç†å‘˜å¯ä»¥ä½¿ç”¨ç›¸å…³æ¥å£ç®¡ç†ç”¨æˆ·è´¦æˆ·
    
  version: 1.0.0
  contact:
    name: APIæ”¯æŒ
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8000
    description: å¼€å‘ç¯å¢ƒ
  - url: https://api.example.com
    description: ç”Ÿäº§ç¯å¢ƒ

paths:
  # ç³»ç»Ÿä¿¡æ¯æ¥å£
  /:
    get:
      summary: æœåŠ¡ä¿¡æ¯
      description: è·å–APIæœåŠ¡åŸºæœ¬ä¿¡æ¯
      tags:
        - ç³»ç»Ÿ
      responses:
        '200':
          description: æœåŠ¡ä¿¡æ¯
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "æ¬¢è¿ä½¿ç”¨FastAPIç”¨æˆ·æœåŠ¡"
                  app_name:
                    type: string
                    example: "FastAPIç”¨æˆ·æœåŠ¡"
                  version:
                    type: string
                    example: "1.0.0"

  /health:
    get:
      summary: å¥åº·æ£€æŸ¥
      description: æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
      tags:
        - ç³»ç»Ÿ
      responses:
        '200':
          description: æœåŠ¡å¥åº·
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  timestamp:
                    type: number
                  database:
                    type: string
                    example: "connected"
        '503':
          description: æœåŠ¡ä¸å¥åº·
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "unhealthy"
                  error:
                    type: string

  # ç”¨æˆ·æ³¨å†Œæ¥å£
  /user/register:
    post:
      summary: ç”¨æˆ·æ³¨å†Œ
      description: åˆ›å»ºæ–°ç”¨æˆ·è´¦æˆ·
      tags:
        - ç”¨æˆ·ç®¡ç†
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreate'
            examples:
              basic_user:
                summary: åŸºç¡€ç”¨æˆ·æ³¨å†Œ
                value:
                  username: "testuser"
                  email: "test@example.com"
                  password: "SecurePass123"
                  password_confirm: "SecurePass123"
                  full_name: "Test User"
      responses:
        '201':
          description: æ³¨å†ŒæˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserApiResponse'
        '400':
          description: æ³¨å†Œå¤±è´¥ - æ•°æ®éªŒè¯é”™è¯¯
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: æ³¨å†ŒåŠŸèƒ½å·²ç¦ç”¨
        '409':
          description: ç”¨æˆ·åæˆ–é‚®ç®±å·²å­˜åœ¨

  # ç”¨æˆ·ç™»å½•æ¥å£
  /user/login:
    post:
      summary: ç”¨æˆ·ç™»å½•
      description: ç”¨æˆ·ç™»å½•è·å–JWT Token
      tags:
        - è®¤è¯æˆæƒ
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                username:
                  type: string
                  description: ç”¨æˆ·åæˆ–é‚®ç®±
                password:
                  type: string
                  description: å¯†ç 
              required:
                - username
                - password
      responses:
        '200':
          description: ç™»å½•æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: ç™»å½•å¤±è´¥ - ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '423':
          description: è´¦æˆ·è¢«é”å®š

  # ç”¨æˆ·ä¿¡æ¯æ¥å£
  /user/profile:
    get:
      summary: è·å–ç”¨æˆ·ä¿¡æ¯
      description: è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯
      tags:
        - ç”¨æˆ·ç®¡ç†
      security:
        - BearerAuth: []
      responses:
        '200':
          description: è·å–æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserApiResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    
    put:
      summary: æ›´æ–°ç”¨æˆ·ä¿¡æ¯
      description: æ›´æ–°å½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯
      tags:
        - ç”¨æˆ·ç®¡ç†
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdate'
      responses:
        '200':
          description: æ›´æ–°æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserApiResponse'
        '400':
          description: æ•°æ®éªŒè¯é”™è¯¯
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  # ä¿®æ”¹å¯†ç æ¥å£
  /user/change-password:
    post:
      summary: ä¿®æ”¹å¯†ç 
      description: ä¿®æ”¹å½“å‰ç™»å½•ç”¨æˆ·çš„å¯†ç 
      tags:
        - ç”¨æˆ·ç®¡ç†
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserPasswordChange'
      responses:
        '200':
          description: å¯†ç ä¿®æ”¹æˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "å¯†ç ä¿®æ”¹æˆåŠŸ"
        '400':
          description: å½“å‰å¯†ç é”™è¯¯æˆ–æ–°å¯†ç ä¸ç¬¦åˆè¦æ±‚
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  # ç”¨æˆ·åˆ—è¡¨æ¥å£ï¼ˆç®¡ç†å‘˜ï¼‰
  /user/list:
    get:
      summary: è·å–ç”¨æˆ·åˆ—è¡¨
      description: è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
      tags:
        - ç”¨æˆ·ç®¡ç†
      security:
        - BearerAuth: []
      parameters:
        - name: keyword
          in: query
          description: æœç´¢å…³é”®è¯
          schema:
            type: string
        - name: is_active
          in: query
          description: æ˜¯å¦æ¿€æ´»
          schema:
            type: boolean
        - name: page
          in: query
          description: é¡µç 
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: size
          in: query
          description: æ¯é¡µå¤§å°
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: è·å–æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'

  # è·å–æŒ‡å®šç”¨æˆ·ä¿¡æ¯
  /user/{user_id}:
    get:
      summary: è·å–æŒ‡å®šç”¨æˆ·ä¿¡æ¯
      description: æ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·ä¿¡æ¯
      tags:
        - ç”¨æˆ·ç®¡ç†
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          description: ç”¨æˆ·ID
          schema:
            type: integer
      responses:
        '200':
          description: è·å–æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserApiResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          description: ç”¨æˆ·ä¸å­˜åœ¨
    
    delete:
      summary: åˆ é™¤ç”¨æˆ·
      description: åˆ é™¤æŒ‡å®šç”¨æˆ·ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
      tags:
        - ç”¨æˆ·ç®¡ç†
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          description: ç”¨æˆ·ID
          schema:
            type: integer
      responses:
        '200':
          description: åˆ é™¤æˆåŠŸ
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          description: ç”¨æˆ·ä¸å­˜åœ¨

  # æ¿€æ´»ç”¨æˆ·
  /user/{user_id}/activate:
    post:
      summary: æ¿€æ´»ç”¨æˆ·
      description: æ¿€æ´»æŒ‡å®šç”¨æˆ·è´¦æˆ·ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
      tags:
        - ç”¨æˆ·ç®¡ç†
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          description: ç”¨æˆ·ID
          schema:
            type: integer
      responses:
        '200':
          description: æ¿€æ´»æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserApiResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          description: ç”¨æˆ·ä¸å­˜åœ¨

  # ç¦ç”¨ç”¨æˆ·
  /user/{user_id}/deactivate:
    post:
      summary: ç¦ç”¨ç”¨æˆ·
      description: ç¦ç”¨æŒ‡å®šç”¨æˆ·è´¦æˆ·ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
      tags:
        - ç”¨æˆ·ç®¡ç†
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          description: ç”¨æˆ·ID
          schema:
            type: integer
      responses:
        '200':
          description: ç¦ç”¨æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserApiResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          description: ç”¨æˆ·ä¸å­˜åœ¨

  # ç”¨æˆ·ç»Ÿè®¡
  /user/stats/overview:
    get:
      summary: ç”¨æˆ·ç»Ÿè®¡æ¦‚è§ˆ
      description: è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
      tags:
        - ç”¨æˆ·ç®¡ç†
      security:
        - BearerAuth: []
      responses:
        '200':
          description: è·å–æˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/UserStats'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'

  # åˆ·æ–°Token
  /auth/refresh:
    post:
      summary: åˆ·æ–°Token
      description: ä½¿ç”¨åˆ·æ–°Tokenè·å–æ–°çš„è®¿é—®Token
      tags:
        - è®¤è¯æˆæƒ
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
      responses:
        '200':
          description: åˆ·æ–°æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshTokenResponse'
        '401':
          description: åˆ·æ–°Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ

components:
  schemas:
    # ç”¨æˆ·ç›¸å…³æ¨¡å‹
    UserBase:
      type: object
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 20
          pattern: "^[a-zA-Z0-9_-]+$"
          description: ç”¨æˆ·å
        email:
          type: string
          format: email
          maxLength: 254
          description: é‚®ç®±åœ°å€
        full_name:
          type: string
          maxLength: 100
          description: å…¨å
        bio:
          type: string
          maxLength: 500
          description: ä¸ªäººç®€ä»‹
      required:
        - username
        - email

    UserCreate:
      allOf:
        - $ref: '#/components/schemas/UserBase'
        - type: object
          properties:
            password:
              type: string
              minLength: 8
              maxLength: 50
              description: å¯†ç 
            password_confirm:
              type: string
              minLength: 8
              maxLength: 50
              description: ç¡®è®¤å¯†ç 
          required:
            - password
            - password_confirm

    UserUpdate:
      type: object
      properties:
        full_name:
          type: string
          maxLength: 100
          description: å…¨å
        bio:
          type: string
          maxLength: 500
          description: ä¸ªäººç®€ä»‹
        avatar_url:
          type: string
          maxLength: 500
          description: å¤´åƒURL

    UserPasswordChange:
      type: object
      properties:
        current_password:
          type: string
          description: å½“å‰å¯†ç 
        new_password:
          type: string
          minLength: 8
          maxLength: 50
          description: æ–°å¯†ç 
        new_password_confirm:
          type: string
          minLength: 8
          maxLength: 50
          description: ç¡®è®¤æ–°å¯†ç 
      required:
        - current_password
        - new_password
        - new_password_confirm

    UserResponse:
      allOf:
        - $ref: '#/components/schemas/UserBase'
        - type: object
          properties:
            id:
              type: integer
              description: ç”¨æˆ·ID
            uuid:
              type: string
              description: ç”¨æˆ·UUID
            is_active:
              type: boolean
              description: æ˜¯å¦æ¿€æ´»
            is_verified:
              type: boolean
              description: æ˜¯å¦å·²éªŒè¯é‚®ç®±
            is_superuser:
              type: boolean
              description: æ˜¯å¦ä¸ºè¶…çº§ç”¨æˆ·
            last_login_at:
              type: string
              format: date-time
              description: æœ€åç™»å½•æ—¶é—´
            login_count:
              type: integer
              description: ç™»å½•æ¬¡æ•°
            created_at:
              type: string
              format: date-time
              description: åˆ›å»ºæ—¶é—´
            updated_at:
              type: string
              format: date-time
              description: æ›´æ–°æ—¶é—´

    UserListResponse:
      type: object
      properties:
        users:
          type: array
          items:
            $ref: '#/components/schemas/UserResponse'
        total:
          type: integer
          description: æ€»æ•°
        page:
          type: integer
          description: å½“å‰é¡µ
        size:
          type: integer
          description: æ¯é¡µå¤§å°
        pages:
          type: integer
          description: æ€»é¡µæ•°

    UserStats:
      type: object
      properties:
        total_users:
          type: integer
          description: æ€»ç”¨æˆ·æ•°
        active_users:
          type: integer
          description: æ´»è·ƒç”¨æˆ·æ•°
        verified_users:
          type: integer
          description: å·²éªŒè¯ç”¨æˆ·æ•°
        superusers:
          type: integer
          description: è¶…çº§ç”¨æˆ·æ•°
        new_users_today:
          type: integer
          description: ä»Šæ—¥æ–°ç”¨æˆ·
        new_users_this_week:
          type: integer
          description: æœ¬å‘¨æ–°ç”¨æˆ·
        new_users_this_month:
          type: integer
          description: æœ¬æœˆæ–°ç”¨æˆ·

    # è®¤è¯ç›¸å…³æ¨¡å‹
    Token:
      type: object
      properties:
        access_token:
          type: string
          description: è®¿é—®Token
        token_type:
          type: string
          default: "bearer"
          description: Tokenç±»å‹
        expires_in:
          type: integer
          description: è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
        refresh_token:
          type: string
          description: åˆ·æ–°Token

    LoginResponse:
      allOf:
        - $ref: '#/components/schemas/Token'
        - type: object
          properties:
            user:
              $ref: '#/components/schemas/UserResponse'

    RefreshTokenRequest:
      type: object
      properties:
        refresh_token:
          type: string
          description: åˆ·æ–°Token
      required:
        - refresh_token

    RefreshTokenResponse:
      type: object
      properties:
        access_token:
          type: string
          description: æ–°çš„è®¿é—®Token
        token_type:
          type: string
          default: "bearer"
          description: Tokenç±»å‹
        expires_in:
          type: integer
          description: è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰

    # APIå“åº”æ¨¡å‹
    UserApiResponse:
      type: object
      properties:
        success:
          type: boolean
          description: æ“ä½œæ˜¯å¦æˆåŠŸ
        message:
          type: string
          description: å“åº”æ¶ˆæ¯
        data:
          $ref: '#/components/schemas/UserResponse'

    ErrorResponse:
      type: object
      properties:
        error:
          type: boolean
          example: true
        message:
          type: string
          description: é”™è¯¯æ¶ˆæ¯
        status_code:
          type: integer
          description: HTTPçŠ¶æ€ç 
        details:
          type: array
          items:
            type: object
          description: è¯¦ç»†é”™è¯¯ä¿¡æ¯
        path:
          type: string
          description: è¯·æ±‚è·¯å¾„

  responses:
    UnauthorizedError:
      description: è®¤è¯å¤±è´¥
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: true
            message: "è®¤è¯å¤±è´¥ï¼Œè¯·ç™»å½•"
            status_code: 401

    ForbiddenError:
      description: æƒé™ä¸è¶³
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: true
            message: "æƒé™ä¸è¶³"
            status_code: 403

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        ä½¿ç”¨JWT Tokenè¿›è¡Œè®¤è¯ã€‚
        
        åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ : `Authorization: Bearer <token>`
        
        Tokenå¯ä»¥é€šè¿‡ç™»å½•æ¥å£è·å–ã€‚

tags:
  - name: ç³»ç»Ÿ
    description: ç³»ç»Ÿä¿¡æ¯å’Œå¥åº·æ£€æŸ¥
  - name: ç”¨æˆ·ç®¡ç†
    description: ç”¨æˆ·æ³¨å†Œã€ä¿¡æ¯ç®¡ç†ç­‰æ“ä½œ
  - name: è®¤è¯æˆæƒ
    description: ç”¨æˆ·ç™»å½•ã€Tokenç®¡ç†ç­‰è®¤è¯ç›¸å…³æ“ä½œ

externalDocs:
  description: é¡¹ç›®æ–‡æ¡£
  url: https://github.com/example/fastapi-user-service