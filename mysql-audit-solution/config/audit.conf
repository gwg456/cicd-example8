# MySQL 审计系统主配置文件
# 配置文件格式: YAML

# ==============================================
# 数据库连接配置
# ==============================================
mysql:
  host: localhost
  port: 3306
  user: mysql_audit_user
  password: "{{ MYSQL_AUDIT_PASSWORD }}"
  database: mysql
  charset: utf8mb4
  connect_timeout: 10
  autocommit: true
  
audit_database:
  host: localhost
  port: 3306  
  user: mysql_audit_user
  password: "{{ MYSQL_AUDIT_PASSWORD }}"
  database: mysql_audit
  charset: utf8mb4
  pool_size: 10
  max_overflow: 20

# ==============================================
# 数据收集器配置
# ==============================================
collectors:
  # General Log 收集器
  general_log:
    enabled: true
    file_path: /var/log/mysql/general.log
    poll_interval: 1  # 秒
    max_file_size: 100MB
    encoding: utf-8
    
  # Binary Log 收集器  
  binary_log:
    enabled: true
    start_position: auto  # auto, latest, specific
    server_id: 1
    heartbeat_interval: 30
    
  # Slow Query Log 收集器
  slow_log:
    enabled: true
    file_path: /var/log/mysql/slow.log
    poll_interval: 5
    min_duration: 2.0  # 最小记录时长(秒)
    
  # Performance Schema 收集器
  performance_schema:
    enabled: true
    collect_interval: 10  # 秒
    tables:
      - events_statements_current
      - events_statements_history
      - events_statements_history_long
      - events_waits_current
      - events_waits_history

# ==============================================
# 数据存储配置
# ==============================================
storage:
  # 主存储类型: mysql, postgresql, elasticsearch
  type: mysql
  
  # MySQL存储配置
  mysql:
    host: localhost
    port: 3306
    database: mysql_audit
    
  # 数据保留策略
  retention:
    audit_logs: 90  # 天
    security_events: 365
    statistics: 1095  # 3年
    
  # 批量插入配置
  batch:
    size: 1000
    timeout: 30  # 秒
    
  # 分区配置
  partitioning:
    enabled: true
    type: range  # range, hash, list
    interval: month  # day, week, month, year

# ==============================================
# 分析器配置  
# ==============================================
analyzers:
  # SQL注入检测
  sql_injection:
    enabled: true
    sensitivity: medium  # low, medium, high
    whitelist_users: [root, mysql_audit_user]
    
  # 异常行为检测
  anomaly_detection:
    enabled: true
    baseline_days: 30
    threshold_multiplier: 3.0
    
  # 权限提升检测
  privilege_escalation:
    enabled: true
    monitor_commands: [GRANT, REVOKE, CREATE USER, ALTER USER]
    
  # 数据泄露检测
  data_leakage:
    enabled: true
    large_result_threshold: 10000
    sensitive_tables: [users, passwords, cards]

# ==============================================
# 告警配置
# ==============================================
alerts:
  # 邮件告警
  email:
    enabled: true
    smtp_server: smtp.company.com
    smtp_port: 587
    use_tls: true
    username: "alerts@company.com"
    password: "{{ EMAIL_PASSWORD }}"
    recipients:
      - admin@company.com
      - security@company.com
    subject_prefix: "[MySQL审计]"
    
  # Webhook告警
  webhook:
    enabled: false
    url: https://hooks.company.com/mysql-audit
    timeout: 30
    retry_count: 3
    
  # 钉钉告警
  dingtalk:
    enabled: false
    webhook_url: "{{ DINGTALK_WEBHOOK }}"
    secret: "{{ DINGTALK_SECRET }}"
    
  # 企业微信告警
  wechat:
    enabled: false
    webhook_url: "{{ WECHAT_WEBHOOK }}"
    
  # 告警规则
  rules:
    # 高风险SQL注入
    - name: high_risk_sql_injection
      condition: risk_level == 'high' AND analyzer == 'sql_injection'
      severity: critical
      actions: [email, webhook]
      throttle: 300  # 5分钟内相同告警只发送一次
      
    # 频繁失败登录
    - name: frequent_login_failures
      condition: failed_logins > 5 in 5min
      severity: high
      actions: [email]
      throttle: 600
      
    # 大量数据导出
    - name: large_data_export
      condition: rows_affected > 50000 AND command == 'SELECT'
      severity: medium
      actions: [email]
      throttle: 1800
      
    # 非工作时间访问
    - name: after_hours_access
      condition: hour < 8 OR hour > 18
      severity: low
      actions: [log]
      throttle: 3600

# ==============================================
# 安全配置
# ==============================================
security:
  # 数据加密
  encryption:
    enabled: true
    algorithm: AES-256
    key_file: /etc/mysql-audit/encryption.key
    
  # 访问控制
  access_control:
    enabled: true
    allowed_hosts: [127.0.0.1, localhost]
    admin_users: [admin, root]
    
  # 审计日志完整性
  integrity:
    enabled: true
    hash_algorithm: SHA256
    sign_logs: true
    
  # 敏感数据脱敏
  data_masking:
    enabled: true
    mask_patterns:
      - pattern: "password\\s*=\\s*'([^']+)'"
        replacement: "password = '***MASKED***'"
      - pattern: "\\b\\d{4}[\\s-]?\\d{4}[\\s-]?\\d{4}[\\s-]?\\d{4}\\b"
        replacement: "****-****-****-****"

# ==============================================
# 性能优化配置
# ==============================================
performance:
  # 线程池配置
  thread_pool:
    size: 10
    max_size: 50
    queue_size: 1000
    
  # 缓存配置
  cache:
    enabled: true
    type: redis  # memory, redis, memcached
    redis:
      host: localhost
      port: 6379
      db: 0
      password: ""
      max_connections: 20
      
  # 队列配置
  queue:
    enabled: true
    type: memory  # memory, redis, rabbitmq
    max_size: 10000
    
  # 采样配置
  sampling:
    enabled: false
    rate: 0.1  # 10%采样率
    exclude_users: [mysql_audit_user]

# ==============================================
# 日志配置
# ==============================================
logging:
  level: INFO  # DEBUG, INFO, WARNING, ERROR, CRITICAL
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  
  # 文件日志
  file:
    enabled: true
    path: /var/log/mysql-audit/audit.log
    max_size: 100MB
    backup_count: 10
    
  # 控制台日志
  console:
    enabled: true
    
  # 系统日志
  syslog:
    enabled: false
    facility: local0

# ==============================================
# Web界面配置
# ==============================================
web:
  enabled: true
  host: 0.0.0.0
  port: 8080
  debug: false
  secret_key: "{{ WEB_SECRET_KEY }}"
  
  # 认证配置
  auth:
    enabled: true
    type: local  # local, ldap, oauth
    session_timeout: 3600  # 秒
    
  # HTTPS配置
  https:
    enabled: false
    cert_file: /etc/ssl/certs/mysql-audit.crt
    key_file: /etc/ssl/private/mysql-audit.key

# ==============================================
# API配置
# ==============================================
api:
  enabled: true
  host: 0.0.0.0
  port: 8081
  version: v1
  
  # API认证
  auth:
    enabled: true
    type: token  # token, basic, oauth
    token_expiry: 86400  # 24小时
    
  # 限流配置
  rate_limiting:
    enabled: true
    requests_per_minute: 1000
    burst_size: 100

# ==============================================
# 监控配置
# ==============================================
monitoring:
  # Prometheus指标
  prometheus:
    enabled: true
    port: 9090
    path: /metrics
    
  # 健康检查
  health_check:
    enabled: true
    endpoint: /health
    interval: 30  # 秒
    
  # 性能指标
  metrics:
    enabled: true
    collection_interval: 60
    
# ==============================================
# 扩展配置
# ==============================================
extensions:
  # 插件目录
  plugin_directory: /usr/local/lib/mysql-audit/plugins
  
  # 启用的插件
  enabled_plugins:
    - custom_rules
    - export_tools
    
  # 插件配置
  plugin_config:
    custom_rules:
      config_file: /etc/mysql-audit/custom_rules.yaml
    export_tools:
      output_directory: /var/lib/mysql-audit/exports

# ==============================================
# 环境变量
# ==============================================
# 支持的环境变量:
# - MYSQL_AUDIT_PASSWORD: MySQL审计用户密码
# - EMAIL_PASSWORD: 邮件服务密码  
# - DINGTALK_WEBHOOK: 钉钉Webhook URL
# - DINGTALK_SECRET: 钉钉签名密钥
# - WECHAT_WEBHOOK: 企业微信Webhook URL
# - WEB_SECRET_KEY: Web界面密钥