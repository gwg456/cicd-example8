# ===============================
# MySQL 5.6+ 审计表配置文件
# 支持 MySQL 5.6, 5.7, 8.0 版本
# ===============================

# MySQL连接配置
mysql:
  host: "localhost"
  port: 3306
  user: "audit_monitor"
  password: "AuditMonitor2024!"
  database: "mysql_audit"
  audit_log_file: "/var/log/mysql/audit.log"
  
  # MySQL版本特定配置
  version: "5.6"  # 支持 5.6, 5.7, 8.0
  
  # 插件配置（针对5.6版本优化）
  plugin_config:
    events: "CONNECT,QUERY,TABLE"
    output_type: "file"
    file_rotate_size: 100000000  # 100MB
    file_rotations: 10
    syslog_priority: "LOG_INFO"

# 审计配置
audit_config:
  # 指定需要审计的表
  target_tables:
    - database: "production"
      table: "users"
      operations: ["INSERT", "UPDATE", "DELETE"]
      sensitive_fields: ["password", "email", "phone"]
      alert_on_delete: true
      description: "用户基础信息表"
      
    - database: "production" 
      table: "orders"
      operations: ["INSERT", "UPDATE", "DELETE"]
      alert_on_delete: true
      alert_threshold: 100
      description: "订单表"
      
    - database: "production"
      table: "payments"
      operations: ["INSERT", "UPDATE", "DELETE"] 
      alert_threshold: 50  # 批量操作告警阈值
      high_priority: true
      description: "支付记录表"
      
    - database: "finance"
      table: "transactions"
      operations: ["INSERT", "UPDATE", "DELETE"]
      sensitive_fields: ["amount", "account_number"]
      high_priority: true
      alert_on_delete: true
      description: "财务交易表"
      
    - database: "production"
      table: "user_profiles"
      operations: ["INSERT", "UPDATE", "DELETE"]
      sensitive_fields: ["id_card", "bank_account"]
      description: "用户档案表"

  # 排除的表（避免审计系统表）
  exclude_tables:
    - "mysql.*"
    - "information_schema.*"
    - "performance_schema.*"
    - "sys.*"
    - "*.logs"
    - "*.cache"
    - "*_backup"
    - "*_temp"

  # 用户过滤配置
  audit_users:
    # 包含的用户（只审计这些用户）
    include: ["app_user", "admin_user", "api_user"]
    
    # 排除的用户（不审计这些用户）
    exclude: ["backup_user", "monitor_user", "replication_user", "mysql.session", "mysql.sys"]
    
    # 特殊关注用户（高优先级告警）
    high_priority: ["admin_user", "root"]

  # 操作类型过滤
  operations:
    ddl: true      # 审计DDL操作（CREATE, ALTER, DROP）
    dml: true      # 审计DML操作（INSERT, UPDATE, DELETE）
    dcl: false     # 不审计权限操作（GRANT, REVOKE）
    select: false  # 不审计SELECT操作（减少日志量）

  # 时间过滤
  time_filters:
    # 工作时间外的操作需要特别关注
    work_hours:
      start: "08:00"
      end: "18:00"
      weekdays_only: true
    
    # 非工作时间告警
    alert_after_hours: true

# 告警配置
alerts:
  # 邮件告警
  email:
    enabled: true
    smtp_server: "smtp.company.com"
    smtp_port: 587
    smtp_user: "audit@company.com"
    smtp_password: "EmailPassword123!"
    sender: "MySQL审计系统 <audit@company.com>"
    recipients: 
      - "admin@company.com"
      - "security@company.com"
    
    # 邮件模板
    subject_template: "[MySQL审计] {severity} - {operation} on {database}.{table}"
    
    # 批量告警设置
    batch_alerts: true
    batch_interval: 300  # 5分钟
    max_alerts_per_batch: 10

  # Webhook告警
  webhook:
    enabled: false
    url: "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
    timeout: 30

  # 告警级别配置
  severity_rules:
    critical:
      - delete_operations: true
      - bulk_operations: 1000
      - after_hours_admin: true
      - sensitive_fields_access: true
    
    high:
      - bulk_operations: 500
      - ddl_operations: true
      - after_hours_operations: true
    
    medium:
      - bulk_operations: 100
      - new_user_access: true
    
    low:
      - normal_operations: true

# 日志配置
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  file: "/var/log/mysql-audit/monitor.log"
  max_file_size: "100MB"
  backup_count: 10
  
  # 日志格式
  format: "{time} | {level} | {module} | {message}"
  
  # 性能日志
  performance_log: true
  slow_operation_threshold: 5.0  # 秒

# 存储配置
storage:
  # 审计事件存储
  events:
    type: "mysql"  # mysql, sqlite, file
    retention_days: 90
    table_prefix: "audit_"
    
    # 分表策略
    partition_by: "month"  # day, week, month
    
  # 统计信息存储
  statistics:
    enabled: true
    aggregation_interval: 3600  # 1小时
    retention_days: 365

# 性能优化配置
performance:
  # 处理配置
  processing:
    process_existing: false  # 是否处理现有日志
    batch_size: 1000
    worker_threads: 2
    queue_size: 10000
  
  # 缓存配置
  cache:
    enabled: true
    table_cache_size: 1000
    user_cache_size: 500
    cache_ttl: 3600
  
  # 数据库连接池
  connection_pool:
    max_connections: 10
    min_connections: 2
    connection_timeout: 30

# MySQL 5.6 特定配置
mysql_5_6:
  # 插件兼容性设置
  plugin_compatibility:
    use_legacy_api: true
    event_format: "csv"
    
  # 性能优化
  performance_tweaks:
    disable_query_cache: false
    optimize_for_5_6: true
    
  # 功能限制
  limitations:
    no_json_support: true
    limited_events: true
    basic_filtering: true

# 监控和健康检查
monitoring:
  # 健康检查
  health_check:
    enabled: true
    interval: 60  # 秒
    
  # 指标收集
  metrics:
    enabled: true
    collection_interval: 300  # 5分钟
    
    # 关键指标
    key_metrics:
      - "events_per_second"
      - "table_operations_count"
      - "alert_count"
      - "processing_lag"
      
  # 状态报告
  status_report:
    enabled: true
    interval: 3600  # 1小时
    email_report: true

# 安全配置
security:
  # 敏感数据处理
  data_protection:
    mask_sensitive_fields: true
    mask_pattern: "***"
    hash_passwords: true
    
  # 访问控制
  access_control:
    require_ssl: false  # MySQL 5.6可能不支持
    min_password_length: 8
    
  # 审计日志保护
  log_protection:
    file_permissions: "640"
    owner: "mysql-audit"
    group: "mysql-audit"