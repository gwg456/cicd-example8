name: å¤šæœåŠ¡å™¨å¹¶è¡Œéƒ¨ç½²

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      servers:
        description: 'ç›®æ ‡æœåŠ¡å™¨ (é€—å·åˆ†éš”)'
        required: false
        default: 'all'
      skip_backup:
        description: 'è·³è¿‡å¤‡ä»½'
        required: false
        default: false
        type: boolean

jobs:
  prepare:
    runs-on: ubuntu-latest
    name: å‡†å¤‡éƒ¨ç½²
    outputs:
      servers: ${{ steps.setup.outputs.servers }}
      timestamp: ${{ steps.setup.outputs.timestamp }}
      
    steps:
    - name: è®¾ç½®éƒ¨ç½²å‚æ•°
      id: setup
      run: |
        # è®¾ç½®æ—¶é—´æˆ³
        echo "timestamp=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT
        
        # è®¾ç½®æœåŠ¡å™¨åˆ—è¡¨
        if [ "${{ github.event.inputs.servers }}" == "all" ] || [ -z "${{ github.event.inputs.servers }}" ]; then
          echo "servers=[\"web1\", \"web2\", \"web3\", \"api1\", \"api2\"]" >> $GITHUB_OUTPUT
        else
          # è½¬æ¢é€—å·åˆ†éš”çš„æœåŠ¡å™¨åˆ—è¡¨ä¸º JSON æ•°ç»„
          servers="${{ github.event.inputs.servers }}"
          json_array=$(echo "$servers" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
          echo "servers=$json_array" >> $GITHUB_OUTPUT
        fi

  deploy-web-servers:
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      matrix:
        server: ${{ fromJson(needs.prepare.outputs.servers) }}
      fail-fast: false
      max-parallel: 3
    name: éƒ¨ç½²åˆ° ${{ matrix.server }}
    
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      
    - name: è·å–æœåŠ¡å™¨é…ç½®
      id: config
      run: |
        case "${{ matrix.server }}" in
          "web1")
            echo "host=${{ secrets.WEB1_SSH_HOST }}" >> $GITHUB_OUTPUT
            echo "username=${{ secrets.WEB1_SSH_USERNAME }}" >> $GITHUB_OUTPUT
            echo "key=${{ secrets.WEB1_SSH_PRIVATE_KEY }}" >> $GITHUB_OUTPUT
            echo "port=${{ secrets.WEB1_SSH_PORT || 22 }}" >> $GITHUB_OUTPUT
            echo "type=web" >> $GITHUB_OUTPUT
            ;;
          "web2")
            echo "host=${{ secrets.WEB2_SSH_HOST }}" >> $GITHUB_OUTPUT
            echo "username=${{ secrets.WEB2_SSH_USERNAME }}" >> $GITHUB_OUTPUT
            echo "key=${{ secrets.WEB2_SSH_PRIVATE_KEY }}" >> $GITHUB_OUTPUT
            echo "port=${{ secrets.WEB2_SSH_PORT || 22 }}" >> $GITHUB_OUTPUT
            echo "type=web" >> $GITHUB_OUTPUT
            ;;
          "web3")
            echo "host=${{ secrets.WEB3_SSH_HOST }}" >> $GITHUB_OUTPUT
            echo "username=${{ secrets.WEB3_SSH_USERNAME }}" >> $GITHUB_OUTPUT
            echo "key=${{ secrets.WEB3_SSH_PRIVATE_KEY }}" >> $GITHUB_OUTPUT
            echo "port=${{ secrets.WEB3_SSH_PORT || 22 }}" >> $GITHUB_OUTPUT
            echo "type=web" >> $GITHUB_OUTPUT
            ;;
          "api1")
            echo "host=${{ secrets.API1_SSH_HOST }}" >> $GITHUB_OUTPUT
            echo "username=${{ secrets.API1_SSH_USERNAME }}" >> $GITHUB_OUTPUT
            echo "key=${{ secrets.API1_SSH_PRIVATE_KEY }}" >> $GITHUB_OUTPUT
            echo "port=${{ secrets.API1_SSH_PORT || 22 }}" >> $GITHUB_OUTPUT
            echo "type=api" >> $GITHUB_OUTPUT
            ;;
          "api2")
            echo "host=${{ secrets.API2_SSH_HOST }}" >> $GITHUB_OUTPUT
            echo "username=${{ secrets.API2_SSH_USERNAME }}" >> $GITHUB_OUTPUT
            echo "key=${{ secrets.API2_SSH_PRIVATE_KEY }}" >> $GITHUB_OUTPUT
            echo "port=${{ secrets.API2_SSH_PORT || 22 }}" >> $GITHUB_OUTPUT
            echo "type=api" >> $GITHUB_OUTPUT
            ;;
        esac
        
    - name: éƒ¨ç½²åˆ° ${{ matrix.server }}
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ steps.config.outputs.host }}
        username: ${{ steps.config.outputs.username }}
        key: ${{ steps.config.outputs.key }}
        port: ${{ steps.config.outputs.port }}
        envs: GITHUB_SHA,GITHUB_REF_NAME,SERVER_NAME,SERVER_TYPE,TIMESTAMP,SKIP_BACKUP
        script: |
          set -e
          
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°æœåŠ¡å™¨: $SERVER_NAME ($SERVER_TYPE)"
          echo "æäº¤ SHA: $GITHUB_SHA"
          echo "åˆ†æ”¯: $GITHUB_REF_NAME"
          echo "æ—¶é—´æˆ³: $TIMESTAMP"
          
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          sudo mkdir -p /opt/myapp/$SERVER_TYPE
          cd /opt/myapp/$SERVER_TYPE
          
          # æ£€æŸ¥å½“å‰æœåŠ¡çŠ¶æ€
          echo "ğŸ“Š æ£€æŸ¥å½“å‰æœåŠ¡çŠ¶æ€..."
          if systemctl is-active myapp-$SERVER_TYPE >/dev/null 2>&1; then
            echo "âœ… æœåŠ¡ myapp-$SERVER_TYPE æ­£åœ¨è¿è¡Œ"
            current_status="running"
          else
            echo "âš ï¸ æœåŠ¡ myapp-$SERVER_TYPE æœªè¿è¡Œ"
            current_status="stopped"
          fi
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬ (å¦‚æœä¸è·³è¿‡å¤‡ä»½)
          if [ "$SKIP_BACKUP" != "true" ] && [ -d "current" ]; then
            echo "ğŸ“¦ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
            sudo cp -r current backup-$TIMESTAMP
            
            # æ¸…ç†æ—§å¤‡ä»½ (ä¿ç•™æœ€æ–°5ä¸ª)
            sudo ls -t backup-* 2>/dev/null | tail -n +6 | xargs -r sudo rm -rf
          fi
          
          # ä¸‹è½½æ–°ç‰ˆæœ¬
          echo "ğŸ“¥ ä¸‹è½½æ–°ç‰ˆæœ¬..."
          sudo mkdir -p new-$TIMESTAMP
          cd new-$TIMESTAMP
          
          # æ ¹æ®æœåŠ¡å™¨ç±»å‹ä¸‹è½½å¯¹åº”çš„æ–‡ä»¶
          if [ "$SERVER_TYPE" == "web" ]; then
            # Web æœåŠ¡å™¨éƒ¨ç½²å‰ç«¯æ–‡ä»¶
            sudo wget -q "https://github.com/${{ github.repository }}/archive/$GITHUB_SHA.tar.gz" -O source.tar.gz
            sudo tar -xzf source.tar.gz --strip-components=1
            
            # æ„å»ºå‰ç«¯
            if command -v npm >/dev/null 2>&1; then
              echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
              npm ci
              npm run build
              sudo cp -r dist/* /var/www/html/
            fi
            
          elif [ "$SERVER_TYPE" == "api" ]; then
            # API æœåŠ¡å™¨éƒ¨ç½²åç«¯æ–‡ä»¶
            sudo wget -q "https://github.com/${{ github.repository }}/archive/$GITHUB_SHA.tar.gz" -O source.tar.gz
            sudo tar -xzf source.tar.gz --strip-components=1
            
            # å®‰è£…ä¾èµ–
            if [ -f "requirements.txt" ]; then
              echo "ğŸ”¨ å®‰è£… Python ä¾èµ–..."
              sudo pip install -r requirements.txt
            elif [ -f "package.json" ]; then
              echo "ğŸ”¨ å®‰è£… Node.js ä¾èµ–..."
              sudo npm ci --production
            fi
          fi
          
          cd ..
          
          # åŸå­åˆ‡æ¢
          echo "ğŸ”„ åŸå­åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬..."
          if [ -d "current" ]; then
            sudo mv current old-$TIMESTAMP
          fi
          sudo mv new-$TIMESTAMP current
          
          # é‡å¯æœåŠ¡
          echo "ğŸ”„ é‡å¯æœåŠ¡..."
          if [ "$SERVER_TYPE" == "web" ]; then
            # é‡å¯ Nginx
            sudo systemctl reload nginx
            echo "âœ… Nginx é…ç½®å·²é‡æ–°åŠ è½½"
            
          elif [ "$SERVER_TYPE" == "api" ]; then
            # é‡å¯ API æœåŠ¡
            if systemctl list-unit-files | grep -q "myapp-$SERVER_TYPE.service"; then
              sudo systemctl restart myapp-$SERVER_TYPE
              echo "âœ… API æœåŠ¡å·²é‡å¯"
            else
              echo "âš ï¸ æœåŠ¡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡é‡å¯"
            fi
          fi
          
          # å¥åº·æ£€æŸ¥
          echo "ğŸ” å¥åº·æ£€æŸ¥..."
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if [ "$SERVER_TYPE" == "web" ]; then
              # æ£€æŸ¥ Web æœåŠ¡å™¨
              if curl -f http://localhost/ >/dev/null 2>&1; then
                echo "âœ… Web æœåŠ¡å™¨å“åº”æ­£å¸¸!"
                break
              fi
            elif [ "$SERVER_TYPE" == "api" ]; then
              # æ£€æŸ¥ API æœåŠ¡å™¨
              if curl -f http://localhost:8080/health >/dev/null 2>&1; then
                echo "âœ… API æœåŠ¡å™¨å“åº”æ­£å¸¸!"
                break
              fi
            fi
            
            echo "â³ ç­‰å¾…æœåŠ¡å“åº”... ($((attempt + 1))/$max_attempts)"
            sleep 10
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå›æ»š..."
            
            # å›æ»šåˆ°æ—§ç‰ˆæœ¬
            if [ -d "old-$TIMESTAMP" ]; then
              sudo mv current failed-$TIMESTAMP
              sudo mv old-$TIMESTAMP current
              
              # é‡å¯æœåŠ¡
              if [ "$SERVER_TYPE" == "web" ]; then
                sudo systemctl reload nginx
              elif [ "$SERVER_TYPE" == "api" ]; then
                sudo systemctl restart myapp-$SERVER_TYPE
              fi
              
              echo "ğŸ”„ å·²å›æ»šåˆ°æ—§ç‰ˆæœ¬"
            fi
            
            exit 1
          fi
          
          # æ¸…ç†
          echo "ğŸ§¹ æ¸…ç†æ—§æ–‡ä»¶..."
          sudo rm -rf old-$TIMESTAMP failed-* 2>/dev/null || true
          
          # è®°å½•éƒ¨ç½²ä¿¡æ¯
          sudo tee deploy-info-$TIMESTAMP.json > /dev/null << EOF
          {
            "deploy_time": "$(date -Iseconds)",
            "commit_sha": "$GITHUB_SHA",
            "branch": "$GITHUB_REF_NAME",
            "server_name": "$SERVER_NAME",
            "server_type": "$SERVER_TYPE",
            "timestamp": "$TIMESTAMP",
            "deployed_by": "${{ github.actor }}",
            "previous_status": "$current_status"
          }
          EOF
          
          echo "ğŸ‰ éƒ¨ç½²åˆ° $SERVER_NAME å®Œæˆ!"
      env:
        SERVER_NAME: ${{ matrix.server }}
        SERVER_TYPE: ${{ steps.config.outputs.type }}
        TIMESTAMP: ${{ needs.prepare.outputs.timestamp }}
        SKIP_BACKUP: ${{ github.event.inputs.skip_backup }}

  health-check:
    runs-on: ubuntu-latest
    needs: [prepare, deploy-web-servers]
    name: å…¨å±€å¥åº·æ£€æŸ¥
    
    steps:
    - name: å…¨å±€æœåŠ¡å¥åº·æ£€æŸ¥
      run: |
        echo "ğŸ” æ‰§è¡Œå…¨å±€å¥åº·æ£€æŸ¥..."
        
        # å®šä¹‰æ£€æŸ¥çš„æœåŠ¡å™¨å’Œç«¯ç‚¹
        declare -A servers=(
          ["web1"]="http://${{ secrets.WEB1_PUBLIC_IP }}/"
          ["web2"]="http://${{ secrets.WEB2_PUBLIC_IP }}/"
          ["web3"]="http://${{ secrets.WEB3_PUBLIC_IP }}/"
          ["api1"]="http://${{ secrets.API1_PUBLIC_IP }}:8080/health"
          ["api2"]="http://${{ secrets.API2_PUBLIC_IP }}:8080/health"
        )
        
        failed_servers=()
        
        for server in "${!servers[@]}"; do
          url="${servers[$server]}"
          echo "æ£€æŸ¥ $server: $url"
          
          if curl -f --connect-timeout 10 --max-time 30 "$url" >/dev/null 2>&1; then
            echo "âœ… $server å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ $server å¥åº·æ£€æŸ¥å¤±è´¥"
            failed_servers+=("$server")
          fi
        done
        
        if [ ${#failed_servers[@]} -eq 0 ]; then
          echo "ğŸ‰ æ‰€æœ‰æœåŠ¡å™¨å¥åº·æ£€æŸ¥é€šè¿‡!"
        else
          echo "âš ï¸ ä»¥ä¸‹æœåŠ¡å™¨å¥åº·æ£€æŸ¥å¤±è´¥: ${failed_servers[*]}"
          echo "::warning::å¥åº·æ£€æŸ¥å¤±è´¥çš„æœåŠ¡å™¨: ${failed_servers[*]}"
        fi

  load-balancer-update:
    runs-on: ubuntu-latest
    needs: [prepare, deploy-web-servers, health-check]
    name: æ›´æ–°è´Ÿè½½å‡è¡¡å™¨
    
    steps:
    - name: æ›´æ–°è´Ÿè½½å‡è¡¡å™¨é…ç½®
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.LB_SSH_HOST }}
        username: ${{ secrets.LB_SSH_USERNAME }}
        key: ${{ secrets.LB_SSH_PRIVATE_KEY }}
        port: ${{ secrets.LB_SSH_PORT || 22 }}
        script: |
          echo "ğŸ”„ æ›´æ–°è´Ÿè½½å‡è¡¡å™¨é…ç½®..."
          
          # æ£€æŸ¥æ‰€æœ‰åç«¯æœåŠ¡å™¨çŠ¶æ€
          backends=(
            "${{ secrets.WEB1_PRIVATE_IP }}:80"
            "${{ secrets.WEB2_PRIVATE_IP }}:80"
            "${{ secrets.WEB3_PRIVATE_IP }}:80"
          )
          
          api_backends=(
            "${{ secrets.API1_PRIVATE_IP }}:8080"
            "${{ secrets.API2_PRIVATE_IP }}:8080"
          )
          
          # ç”Ÿæˆ Nginx ä¸Šæ¸¸é…ç½®
          sudo tee /etc/nginx/conf.d/upstream.conf > /dev/null << EOF
          upstream web_servers {
              least_conn;
          EOF
          
          # æ·»åŠ å¯ç”¨çš„ Web æœåŠ¡å™¨
          for backend in "${backends[@]}"; do
            if curl -f --connect-timeout 5 "http://$backend/health" >/dev/null 2>&1; then
              echo "    server $backend;" | sudo tee -a /etc/nginx/conf.d/upstream.conf
              echo "âœ… æ·»åŠ å¥åº·çš„ Web æœåŠ¡å™¨: $backend"
            else
              echo "    server $backend backup;" | sudo tee -a /etc/nginx/conf.d/upstream.conf
              echo "âš ï¸ å°†æ•…éšœ Web æœåŠ¡å™¨è®¾ä¸ºå¤‡ç”¨: $backend"
            fi
          done
          
          echo "}" | sudo tee -a /etc/nginx/conf.d/upstream.conf
          
          # API æœåŠ¡å™¨ä¸Šæ¸¸é…ç½®
          echo "upstream api_servers {" | sudo tee -a /etc/nginx/conf.d/upstream.conf
          echo "    least_conn;" | sudo tee -a /etc/nginx/conf.d/upstream.conf
          
          for backend in "${api_backends[@]}"; do
            if curl -f --connect-timeout 5 "http://$backend/health" >/dev/null 2>&1; then
              echo "    server $backend;" | sudo tee -a /etc/nginx/conf.d/upstream.conf
              echo "âœ… æ·»åŠ å¥åº·çš„ API æœåŠ¡å™¨: $backend"
            else
              echo "    server $backend backup;" | sudo tee -a /etc/nginx/conf.d/upstream.conf
              echo "âš ï¸ å°†æ•…éšœ API æœåŠ¡å™¨è®¾ä¸ºå¤‡ç”¨: $backend"
            fi
          done
          
          echo "}" | sudo tee -a /etc/nginx/conf.d/upstream.conf
          
          # æµ‹è¯• Nginx é…ç½®
          if sudo nginx -t; then
            echo "âœ… Nginx é…ç½®æµ‹è¯•é€šè¿‡"
            sudo systemctl reload nginx
            echo "ğŸ”„ Nginx é…ç½®å·²é‡æ–°åŠ è½½"
          else
            echo "âŒ Nginx é…ç½®æµ‹è¯•å¤±è´¥"
            exit 1
          fi

  post-deploy-notifications:
    runs-on: ubuntu-latest
    needs: [prepare, deploy-web-servers, health-check, load-balancer-update]
    if: always()
    name: éƒ¨ç½²åé€šçŸ¥
    
    steps:
    - name: æ±‡æ€»éƒ¨ç½²ç»“æœ
      id: summary
      run: |
        echo "ğŸ“Š æ±‡æ€»éƒ¨ç½²ç»“æœ..."
        
        # æ£€æŸ¥å„ä¸ªä½œä¸šçš„çŠ¶æ€
        if [ "${{ needs.deploy-web-servers.result }}" == "success" ]; then
          echo "âœ… å¤šæœåŠ¡å™¨éƒ¨ç½²: æˆåŠŸ"
          deploy_status="success"
        else
          echo "âŒ å¤šæœåŠ¡å™¨éƒ¨ç½²: å¤±è´¥"
          deploy_status="failed"
        fi
        
        if [ "${{ needs.health-check.result }}" == "success" ]; then
          echo "âœ… å¥åº·æ£€æŸ¥: é€šè¿‡"
        else
          echo "âŒ å¥åº·æ£€æŸ¥: å¤±è´¥"
        fi
        
        if [ "${{ needs.load-balancer-update.result }}" == "success" ]; then
          echo "âœ… è´Ÿè½½å‡è¡¡å™¨æ›´æ–°: æˆåŠŸ"
        else
          echo "âŒ è´Ÿè½½å‡è¡¡å™¨æ›´æ–°: å¤±è´¥"
        fi
        
        echo "deploy_status=$deploy_status" >> $GITHUB_OUTPUT
        
    - name: å‘é€éƒ¨ç½²é€šçŸ¥
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            "text": "ğŸš€ å¤šæœåŠ¡å™¨éƒ¨ç½²å®Œæˆ",
            "attachments": [
              {
                "color": "${{ steps.summary.outputs.deploy_status == 'success' && 'good' || 'danger' }}",
                "fields": [
                  {
                    "title": "éƒ¨ç½²çŠ¶æ€",
                    "value": "${{ steps.summary.outputs.deploy_status }}",
                    "short": true
                  },
                  {
                    "title": "æäº¤",
                    "value": "${{ github.sha }}",
                    "short": true
                  },
                  {
                    "title": "åˆ†æ”¯",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "æ“ä½œè€…",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "æ—¶é—´æˆ³",
                    "value": "${{ needs.prepare.outputs.timestamp }}",
                    "short": true
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}