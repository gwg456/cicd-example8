name: åŸºç¡€ SSH è¿æ¥ç¤ºä¾‹

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  basic-ssh-connection:
    runs-on: ubuntu-latest
    name: åŸºç¡€ SSH è¿æ¥æµ‹è¯•
    
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® SSH å¯†é’¥
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        name: id_rsa
        known_hosts: ${{ secrets.KNOWN_HOSTS }}
        if_key_exists: replace
        
    - name: æµ‹è¯• SSH è¿æ¥
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          echo "ğŸ‰ SSH è¿æ¥æˆåŠŸ!"
          echo "å½“å‰æ—¶é—´: $(date)"
          echo "æœåŠ¡å™¨ä¿¡æ¯: $(uname -a)"
          echo "å½“å‰ç”¨æˆ·: $(whoami)"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç£ç›˜ç©ºé—´:"
          df -h
          echo "å†…å­˜ä½¿ç”¨:"
          free -h
          
  ssh-with-commands:
    runs-on: ubuntu-latest
    name: æ‰§è¡Œå¤šä¸ª SSH å‘½ä»¤
    needs: basic-ssh-connection
    
    steps:
    - name: æ‰§è¡Œç³»ç»Ÿæ£€æŸ¥å‘½ä»¤
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          # ç³»ç»Ÿä¿¡æ¯æ£€æŸ¥
          echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
          hostnamectl
          
          echo -e "\n=== CPU ä¿¡æ¯ ==="
          lscpu | head -20
          
          echo -e "\n=== ç½‘ç»œè¿æ¥ ==="
          ss -tuln
          
          echo -e "\n=== è¿è¡Œçš„æœåŠ¡ ==="
          systemctl list-units --type=service --state=running | head -10
          
          echo -e "\n=== ç¯å¢ƒå˜é‡ ==="
          env | grep -E '^(PATH|HOME|USER)='
          
    - name: æ£€æŸ¥ç‰¹å®šæœåŠ¡çŠ¶æ€
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          # æ£€æŸ¥å¸¸è§æœåŠ¡çŠ¶æ€
          services=("nginx" "apache2" "mysql" "postgresql" "redis" "docker")
          
          for service in "${services[@]}"; do
            if systemctl list-unit-files | grep -q "^$service.service"; then
              status=$(systemctl is-active $service 2>/dev/null || echo "not-found")
              echo "ğŸ“‹ $service: $status"
            fi
          done
          
          # æ£€æŸ¥ç«¯å£å ç”¨
          echo -e "\nğŸ”Œ ç«¯å£å ç”¨æƒ…å†µ:"
          netstat -tlnp | grep -E ':(80|443|22|3306|5432|6379) '
          
  ssh-file-operations:
    runs-on: ubuntu-latest
    name: SSH æ–‡ä»¶æ“ä½œç¤ºä¾‹
    
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      
    - name: åˆ›å»ºæµ‹è¯•æ–‡ä»¶
      run: |
        echo "GitHub Actions éƒ¨ç½²æµ‹è¯•" > test-file.txt
        echo "æ„å»ºæ—¶é—´: $(date)" >> test-file.txt
        echo "æäº¤ SHA: ${{ github.sha }}" >> test-file.txt
        echo "åˆ†æ”¯: ${{ github.ref_name }}" >> test-file.txt
        
    - name: ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        source: "test-file.txt"
        target: "/tmp/"
        
    - name: åœ¨æœåŠ¡å™¨ä¸Šå¤„ç†æ–‡ä»¶
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          echo "ğŸ“ æ£€æŸ¥ä¸Šä¼ çš„æ–‡ä»¶:"
          ls -la /tmp/test-file.txt
          
          echo -e "\nğŸ“– æ–‡ä»¶å†…å®¹:"
          cat /tmp/test-file.txt
          
          echo -e "\nâœ… æ–‡ä»¶å¤„ç†å®Œæˆ"
          
          # åˆ›å»ºå¤‡ä»½
          cp /tmp/test-file.txt /tmp/test-file-backup-$(date +%Y%m%d_%H%M%S).txt
          
          echo -e "\nğŸ’¾ å¤‡ä»½æ–‡ä»¶åˆ—è¡¨:"
          ls -la /tmp/test-file-backup-*.txt
          
          # æ¸…ç†æ—§å¤‡ä»½ (ä¿ç•™æœ€æ–°3ä¸ª)
          ls -t /tmp/test-file-backup-*.txt | tail -n +4 | xargs -r rm -f
          
  ssh-with-environment:
    runs-on: ubuntu-latest
    name: SSH ç¯å¢ƒå˜é‡ç¤ºä¾‹
    
    steps:
    - name: ä½¿ç”¨ç¯å¢ƒå˜é‡æ‰§è¡Œå‘½ä»¤
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        envs: GITHUB_SHA,GITHUB_REF_NAME,DEPLOY_ENV
        script: |
          echo "ğŸ”§ GitHub Actions ç¯å¢ƒå˜é‡:"
          echo "SHA: $GITHUB_SHA"
          echo "åˆ†æ”¯: $GITHUB_REF_NAME"
          echo "éƒ¨ç½²ç¯å¢ƒ: $DEPLOY_ENV"
          
          # è®¾ç½®éƒ¨ç½²ç¯å¢ƒ
          export DEPLOY_TIME=$(date)
          export APP_VERSION=$GITHUB_SHA
          
          echo -e "\nğŸ“ éƒ¨ç½²ä¿¡æ¯:"
          echo "éƒ¨ç½²æ—¶é—´: $DEPLOY_TIME"
          echo "åº”ç”¨ç‰ˆæœ¬: $APP_VERSION"
          
          # ä¿å­˜éƒ¨ç½²ä¿¡æ¯
          cat > /tmp/deploy-info.json << EOF
          {
            "deploy_time": "$DEPLOY_TIME",
            "app_version": "$APP_VERSION",
            "branch": "$GITHUB_REF_NAME",
            "commit_sha": "$GITHUB_SHA"
          }
          EOF
          
          echo -e "\nğŸ’¾ éƒ¨ç½²ä¿¡æ¯å·²ä¿å­˜:"
          cat /tmp/deploy-info.json
      env:
        DEPLOY_ENV: production
        
  ssh-error-handling:
    runs-on: ubuntu-latest
    name: SSH é”™è¯¯å¤„ç†ç¤ºä¾‹
    
    steps:
    - name: å‘½ä»¤æ‰§è¡Œä¸é”™è¯¯å¤„ç†
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
          
          echo "ğŸ§ª æµ‹è¯•é”™è¯¯å¤„ç†..."
          
          # æµ‹è¯•æˆåŠŸçš„å‘½ä»¤
          echo "âœ… æˆåŠŸå‘½ä»¤: $(date)"
          
          # æµ‹è¯•å¯èƒ½å¤±è´¥çš„å‘½ä»¤
          if command -v docker >/dev/null 2>&1; then
            echo "âœ… Docker å·²å®‰è£…: $(docker --version)"
          else
            echo "âš ï¸ Docker æœªå®‰è£…"
          fi
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€ (å…è®¸å¤±è´¥)
          if systemctl is-active nginx >/dev/null 2>&1; then
            echo "âœ… Nginx æœåŠ¡è¿è¡Œä¸­"
          else
            echo "âš ï¸ Nginx æœåŠ¡æœªè¿è¡Œæˆ–æœªå®‰è£…"
          fi
          
          echo "ğŸ¯ é”™è¯¯å¤„ç†æµ‹è¯•å®Œæˆ"
          
    - name: æ¡ä»¶æ‰§è¡Œç¤ºä¾‹
      if: success()
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          echo "âœ¨ å‰é¢çš„æ­¥éª¤éƒ½æˆåŠŸäº†ï¼Œæ‰§è¡Œæ¸…ç†ä»»åŠ¡..."
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          find /tmp -name "test-file*" -mtime +1 -delete 2>/dev/null || true
          
          echo "ğŸ§¹ æ¸…ç†å®Œæˆ"