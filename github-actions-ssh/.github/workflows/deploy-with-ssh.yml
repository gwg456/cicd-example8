name: å®Œæ•´åº”ç”¨éƒ¨ç½²ç¤ºä¾‹

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      version:
        description: 'éƒ¨ç½²ç‰ˆæœ¬'
        required: false
        default: 'latest'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    name: æž„å»ºåº”ç”¨
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
      
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ç™»å½•å®¹å™¨æ³¨å†Œè¡¨
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: æž„å»ºå¹¶æŽ¨é€é•œåƒ
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy-staging:
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    runs-on: ubuntu-latest
    needs: build
    environment: staging
    name: éƒ¨ç½²åˆ° Staging çŽ¯å¢ƒ
    
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      
    - name: éƒ¨ç½²åˆ° Staging æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.STAGING_SSH_HOST }}
        username: ${{ secrets.STAGING_SSH_USERNAME }}
        key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
        port: ${{ secrets.STAGING_SSH_PORT || 22 }}
        envs: GITHUB_SHA,GITHUB_REF_NAME,IMAGE_TAG
        script: |
          set -e
          
          echo "ðŸš€ å¼€å§‹éƒ¨ç½²åˆ° Staging çŽ¯å¢ƒ..."
          echo "æäº¤ SHA: $GITHUB_SHA"
          echo "åˆ†æ”¯: $GITHUB_REF_NAME"
          echo "é•œåƒæ ‡ç­¾: $IMAGE_TAG"
          
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          sudo mkdir -p /opt/myapp/staging
          cd /opt/myapp/staging
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          if [ -f docker-compose.yml ]; then
            echo "ðŸ“¦ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
            sudo cp docker-compose.yml docker-compose.yml.backup.$(date +%Y%m%d_%H%M%S)
          fi
          
          # åˆ›å»º docker-compose.yml
          sudo tee docker-compose.yml > /dev/null << EOF
          version: '3.8'
          services:
            app:
              image: $IMAGE_TAG
              container_name: myapp-staging
              restart: unless-stopped
              ports:
                - "8080:8080"
              environment:
                - NODE_ENV=staging
                - DATABASE_URL=\${DATABASE_URL}
                - REDIS_URL=\${REDIS_URL}
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.myapp-staging.rule=Host(\`staging.myapp.com\`)"
                - "traefik.http.routers.myapp-staging.tls=true"
                - "traefik.http.routers.myapp-staging.tls.certresolver=letsencrypt"
              volumes:
                - app-data:/app/data
                - ./logs:/app/logs
              networks:
                - app-network
                
          volumes:
            app-data:
            
          networks:
            app-network:
              external: true
          EOF
          
          # åˆ›å»ºçŽ¯å¢ƒå˜é‡æ–‡ä»¶
          sudo tee .env > /dev/null << EOF
          DATABASE_URL=${{ secrets.STAGING_DATABASE_URL }}
          REDIS_URL=${{ secrets.STAGING_REDIS_URL }}
          JWT_SECRET=${{ secrets.STAGING_JWT_SECRET }}
          EOF
          
          # ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
          echo "${{ secrets.GITHUB_TOKEN }}" | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # æ‹‰å–æœ€æ–°é•œåƒ
          echo "ðŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
          sudo docker-compose pull
          
          # åœæ­¢æ—§å®¹å™¨
          echo "ðŸ›‘ åœæ­¢æ—§å®¹å™¨..."
          sudo docker-compose down || true
          
          # å¯åŠ¨æ–°å®¹å™¨
          echo "ðŸš€ å¯åŠ¨æ–°å®¹å™¨..."
          sudo docker-compose up -d
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 30
          
          # å¥åº·æ£€æŸ¥
          echo "ðŸ” å¥åº·æ£€æŸ¥..."
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:8080/health >/dev/null 2>&1; then
              echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ!"
              break
            fi
            
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($((attempt + 1))/$max_attempts)"
            sleep 10
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶!"
            sudo docker-compose logs
            exit 1
          fi
          
          # æ¸…ç†æ—§é•œåƒ
          echo "ðŸ§¹ æ¸…ç†æ—§é•œåƒ..."
          sudo docker image prune -f
          
          # è®°å½•éƒ¨ç½²ä¿¡æ¯
          sudo tee deploy-info.json > /dev/null << EOF
          {
            "deploy_time": "$(date -Iseconds)",
            "commit_sha": "$GITHUB_SHA",
            "branch": "$GITHUB_REF_NAME",
            "image_tag": "$IMAGE_TAG",
            "environment": "staging",
            "deployed_by": "${{ github.actor }}"
          }
          EOF
          
          echo "ðŸŽ‰ Staging éƒ¨ç½²å®Œæˆ!"
      env:
        IMAGE_TAG: ${{ needs.build.outputs.image-tag }}

  deploy-production:
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.environment == 'production'
    runs-on: ubuntu-latest
    needs: [build, deploy-staging]
    environment: production
    name: éƒ¨ç½²åˆ° Production çŽ¯å¢ƒ
    
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      
    - name: éƒ¨ç½²åˆ° Production æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_SSH_HOST }}
        username: ${{ secrets.PRODUCTION_SSH_USERNAME }}
        key: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}
        port: ${{ secrets.PRODUCTION_SSH_PORT || 22 }}
        envs: GITHUB_SHA,GITHUB_REF_NAME,IMAGE_TAG
        script: |
          set -e
          
          echo "ðŸš€ å¼€å§‹éƒ¨ç½²åˆ° Production çŽ¯å¢ƒ..."
          echo "æäº¤ SHA: $GITHUB_SHA"
          echo "åˆ†æ”¯/æ ‡ç­¾: $GITHUB_REF_NAME"
          echo "é•œåƒæ ‡ç­¾: $IMAGE_TAG"
          
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          sudo mkdir -p /opt/myapp/production
          cd /opt/myapp/production
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          if [ -f docker-compose.yml ]; then
            echo "ðŸ“¦ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
            sudo cp docker-compose.yml docker-compose.yml.backup.$(date +%Y%m%d_%H%M%S)
          fi
          
          # åˆ›å»º docker-compose.yml (ç”Ÿäº§çŽ¯å¢ƒé…ç½®)
          sudo tee docker-compose.yml > /dev/null << EOF
          version: '3.8'
          services:
            app:
              image: $IMAGE_TAG
              container_name: myapp-production
              restart: unless-stopped
              ports:
                - "8080:8080"
              environment:
                - NODE_ENV=production
                - DATABASE_URL=\${DATABASE_URL}
                - REDIS_URL=\${REDIS_URL}
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.myapp.rule=Host(\`myapp.com\`, \`www.myapp.com\`)"
                - "traefik.http.routers.myapp.tls=true"
                - "traefik.http.routers.myapp.tls.certresolver=letsencrypt"
              volumes:
                - app-data:/app/data
                - ./logs:/app/logs
              networks:
                - app-network
              deploy:
                resources:
                  limits:
                    memory: 1G
                    cpus: '0.5'
                  reservations:
                    memory: 512M
                    cpus: '0.25'
                    
          volumes:
            app-data:
            
          networks:
            app-network:
              external: true
          EOF
          
          # åˆ›å»ºçŽ¯å¢ƒå˜é‡æ–‡ä»¶
          sudo tee .env > /dev/null << EOF
          DATABASE_URL=${{ secrets.PRODUCTION_DATABASE_URL }}
          REDIS_URL=${{ secrets.PRODUCTION_REDIS_URL }}
          JWT_SECRET=${{ secrets.PRODUCTION_JWT_SECRET }}
          EOF
          
          # ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
          echo "${{ secrets.GITHUB_TOKEN }}" | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # æ‹‰å–æœ€æ–°é•œåƒ
          echo "ðŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
          sudo docker-compose pull
          
          # æ»šåŠ¨æ›´æ–° (é›¶åœæœºéƒ¨ç½²)
          echo "ðŸ”„ æ‰§è¡Œæ»šåŠ¨æ›´æ–°..."
          
          # å¯åŠ¨æ–°å®¹å™¨ (ä¸åŒåç§°)
          sudo sed 's/myapp-production/myapp-production-new/g' docker-compose.yml > docker-compose-new.yml
          sudo docker-compose -f docker-compose-new.yml up -d
          
          # ç­‰å¾…æ–°å®¹å™¨å¯åŠ¨
          echo "â³ ç­‰å¾…æ–°å®¹å™¨å¯åŠ¨..."
          sleep 60
          
          # å¥åº·æ£€æŸ¥æ–°å®¹å™¨
          if curl -f http://localhost:8080/health >/dev/null 2>&1; then
            echo "âœ… æ–°å®¹å™¨å¯åŠ¨æˆåŠŸï¼Œåˆ‡æ¢æµé‡..."
            
            # åœæ­¢æ—§å®¹å™¨
            sudo docker-compose down || true
            
            # é‡å‘½åæ–°å®¹å™¨
            sudo docker rename myapp-production-new myapp-production
            
            # å¯åŠ¨æ­£å¼å®¹å™¨
            sudo docker-compose up -d
            
            echo "âœ… é›¶åœæœºéƒ¨ç½²å®Œæˆ!"
          else
            echo "âŒ æ–°å®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œå›žæ»š..."
            sudo docker-compose -f docker-compose-new.yml down
            exit 1
          fi
          
          # æ¸…ç†
          sudo rm -f docker-compose-new.yml
          sudo docker image prune -f
          
          # å‘é€éƒ¨ç½²é€šçŸ¥
          echo "ðŸ“¢ å‘é€éƒ¨ç½²é€šçŸ¥..."
          
          # è®°å½•éƒ¨ç½²ä¿¡æ¯
          sudo tee deploy-info.json > /dev/null << EOF
          {
            "deploy_time": "$(date -Iseconds)",
            "commit_sha": "$GITHUB_SHA",
            "branch": "$GITHUB_REF_NAME",
            "image_tag": "$IMAGE_TAG",
            "environment": "production",
            "deployed_by": "${{ github.actor }}"
          }
          EOF
          
          echo "ðŸŽ‰ Production éƒ¨ç½²å®Œæˆ!"
      env:
        IMAGE_TAG: ${{ needs.build.outputs.image-tag }}

  post-deploy:
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    name: éƒ¨ç½²åŽä»»åŠ¡
    
    steps:
    - name: å‘é€ Slack é€šçŸ¥
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: |
          éƒ¨ç½²çŠ¶æ€: ${{ job.status }}
          çŽ¯å¢ƒ: ${{ github.event.inputs.environment || 'auto' }}
          æäº¤: ${{ github.sha }}
          åˆ†æ”¯: ${{ github.ref_name }}
          æ“ä½œè€…: ${{ github.actor }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: åˆ›å»º GitHub Release (ä»…æ ‡ç­¾è§¦å‘)
      if: startsWith(github.ref, 'refs/tags/') && success()
      uses: softprops/action-gh-release@v1
      with:
        generate_release_notes: true
        make_latest: true