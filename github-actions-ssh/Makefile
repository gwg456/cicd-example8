# GitHub Actions SSH ä½¿ç”¨æŒ‡å— - Makefile

.PHONY: help install install-deps pdf pdf-single pdf-batch clean test setup verify all

# é»˜è®¤ç›®æ ‡
help:
	@echo "ğŸ“š GitHub Actions SSH ä½¿ç”¨æŒ‡å— - å¯ç”¨å‘½ä»¤"
	@echo ""
	@echo "ğŸ”§ å®‰è£…å’Œè®¾ç½®:"
	@echo "  make install       - å®Œæ•´å®‰è£…ï¼ˆä¾èµ– + SSH è®¾ç½®ï¼‰"
	@echo "  make install-deps  - ä»…å®‰è£…ä¾èµ–"
	@echo "  make setup         - SSH å¯†é’¥è®¾ç½®"
	@echo "  make verify        - éªŒè¯å®‰è£…"
	@echo "  make test          - è¿è¡Œæµ‹è¯•"
	@echo ""
	@echo "ğŸ“„ PDF ç”Ÿæˆ:"
	@echo "  make pdf           - ç”Ÿæˆä¸»è¦ PDF æ–‡æ¡£"
	@echo "  make pdf-single    - ç”Ÿæˆå•ä¸ªæ–‡ä»¶ PDFï¼ˆFILE=æ–‡ä»¶åï¼‰"
	@echo "  make pdf-batch     - æ‰¹é‡ç”Ÿæˆæ‰€æœ‰ PDF"
	@echo "  make pdf-compress  - æ‰¹é‡ç”Ÿæˆå¹¶å‹ç¼© PDF"
	@echo ""
	@echo "ğŸ§¹ æ¸…ç†:"
	@echo "  make clean         - æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶"
	@echo "  make clean-all     - æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶"
	@echo ""
	@echo "ğŸ“¦ å‘å¸ƒ:"
	@echo "  make package       - æ‰“åŒ…æ‰€æœ‰æ–‡æ¡£"
	@echo "  make release       - åˆ›å»ºå‘å¸ƒç‰ˆæœ¬"
	@echo ""
	@echo "ç¤ºä¾‹:"
	@echo "  make pdf-single FILE=README.md"
	@echo "  make pdf-batch"

# å˜é‡å®šä¹‰
SCRIPTS_DIR = scripts
OUTPUT_DIR = output
DOCS_DIR = docs
PDF_GENERATOR = $(SCRIPTS_DIR)/generate-pdf.py
BATCH_GENERATOR = $(SCRIPTS_DIR)/batch-generate-pdf.sh
INSTALL_SCRIPT = $(SCRIPTS_DIR)/install-dependencies.sh
SSH_SETUP_SCRIPT = $(SCRIPTS_DIR)/setup-ssh-keys.sh

# æ£€æŸ¥ Python ç¯å¢ƒ
check-python:
	@echo "ğŸ æ£€æŸ¥ Python ç¯å¢ƒ..."
	@python3 --version || (echo "âŒ Python 3 æœªå®‰è£…" && exit 1)
	@pip3 --version || (echo "âŒ pip3 æœªå®‰è£…" && exit 1)

# å®‰è£…ä¾èµ–
install-deps:
	@echo "ğŸ“¦ å®‰è£…ä¾èµ–åŒ…..."
	@chmod +x $(INSTALL_SCRIPT)
	@$(INSTALL_SCRIPT)

# SSH å¯†é’¥è®¾ç½®
setup:
	@echo "ğŸ” SSH å¯†é’¥è®¾ç½®..."
	@chmod +x $(SSH_SETUP_SCRIPT)
	@$(SSH_SETUP_SCRIPT)

# å®Œæ•´å®‰è£…
install: install-deps
	@echo "âœ… å®‰è£…å®Œæˆï¼"

# éªŒè¯å®‰è£…
verify:
	@echo "ğŸ” éªŒè¯å®‰è£…..."
	@chmod +x $(INSTALL_SCRIPT)
	@$(INSTALL_SCRIPT) --verify

# è¿è¡Œæµ‹è¯•
test: verify
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	@chmod +x $(INSTALL_SCRIPT)
	@$(INSTALL_SCRIPT) --test

# ç”Ÿæˆä¸»è¦ PDF æ–‡æ¡£
pdf: check-python
	@echo "ğŸ“„ ç”Ÿæˆä¸»è¦ PDF æ–‡æ¡£..."
	@mkdir -p $(OUTPUT_DIR)
	@python3 $(PDF_GENERATOR) README.md -o $(OUTPUT_DIR)/GitHub-Actions-SSH-æŒ‡å—.pdf
	@echo "âœ… PDF ç”Ÿæˆå®Œæˆ: $(OUTPUT_DIR)/GitHub-Actions-SSH-æŒ‡å—.pdf"

# ç”Ÿæˆå•ä¸ªæ–‡ä»¶ PDF
pdf-single: check-python
ifndef FILE
	@echo "âŒ è¯·æŒ‡å®šæ–‡ä»¶å: make pdf-single FILE=æ–‡ä»¶å.md"
	@exit 1
endif
	@echo "ğŸ“„ ç”Ÿæˆ PDF: $(FILE)"
	@mkdir -p $(OUTPUT_DIR)
	@python3 $(PDF_GENERATOR) $(FILE) -o $(OUTPUT_DIR)/$(basename $(FILE)).pdf
	@echo "âœ… PDF ç”Ÿæˆå®Œæˆ: $(OUTPUT_DIR)/$(basename $(FILE)).pdf"

# æ‰¹é‡ç”Ÿæˆ PDF
pdf-batch: check-python
	@echo "ğŸ“š æ‰¹é‡ç”Ÿæˆ PDF..."
	@chmod +x $(BATCH_GENERATOR)
	@$(BATCH_GENERATOR) . $(OUTPUT_DIR)

# æ‰¹é‡ç”Ÿæˆå¹¶å‹ç¼© PDF
pdf-compress: check-python
	@echo "ğŸ“š æ‰¹é‡ç”Ÿæˆå¹¶å‹ç¼© PDF..."
	@chmod +x $(BATCH_GENERATOR)
	@$(BATCH_GENERATOR) -c -i . $(OUTPUT_DIR)

# åˆ›å»ºæ–‡æ¡£ç›®å½•ç»“æ„
docs-structure:
	@echo "ğŸ“ åˆ›å»ºæ–‡æ¡£ç›®å½•ç»“æ„..."
	@mkdir -p $(DOCS_DIR)/images
	@mkdir -p $(DOCS_DIR)/examples
	@mkdir -p $(DOCS_DIR)/templates
	@mkdir -p $(OUTPUT_DIR)/pdf
	@mkdir -p $(OUTPUT_DIR)/html

# ç”Ÿæˆ HTML æ–‡æ¡£
html: check-python docs-structure
	@echo "ğŸŒ ç”Ÿæˆ HTML æ–‡æ¡£..."
	@python3 -c "
import markdown
import os

# è¯»å– README
with open('README.md', 'r', encoding='utf-8') as f:
    content = f.read()

# è½¬æ¢ä¸º HTML
md = markdown.Markdown(extensions=['codehilite', 'fenced_code', 'tables', 'toc'])
html_content = md.convert(content)

# ç”Ÿæˆå®Œæ•´ HTML
full_html = f'''<!DOCTYPE html>
<html lang=\"zh-CN\">
<head>
    <meta charset=\"UTF-8\">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
    <title>GitHub Actions SSH ä½¿ç”¨æŒ‡å—</title>
    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css\">
    <style>
        .markdown-body {{ box-sizing: border-box; min-width: 200px; max-width: 980px; margin: 0 auto; padding: 45px; }}
    </style>
</head>
<body>
    <article class=\"markdown-body\">
        {html_content}
    </article>
</body>
</html>'''

# ä¿å­˜ HTML
with open('$(OUTPUT_DIR)/GitHub-Actions-SSH-æŒ‡å—.html', 'w', encoding='utf-8') as f:
    f.write(full_html)
"
	@echo "âœ… HTML ç”Ÿæˆå®Œæˆ: $(OUTPUT_DIR)/GitHub-Actions-SSH-æŒ‡å—.html"

# æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶..."
	@rm -f *.pdf
	@rm -f test-document.*
	@rm -rf $(OUTPUT_DIR)
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
clean-all: clean
	@echo "ğŸ§¹ æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶..."
	@rm -rf __pycache__
	@rm -rf .pytest_cache
	@rm -f *.pyc
	@find . -name "*.tmp" -delete
	@find . -name ".DS_Store" -delete
	@echo "âœ… å…¨éƒ¨æ¸…ç†å®Œæˆ"

# æ‰“åŒ…æ–‡æ¡£
package: pdf-compress html
	@echo "ğŸ“¦ æ‰“åŒ…æ–‡æ¡£..."
	@mkdir -p releases
	@tar -czf releases/github-actions-ssh-guide-$(shell date +%Y%m%d).tar.gz \
		README.md \
		$(OUTPUT_DIR) \
		.github/workflows \
		scripts \
		requirements.txt \
		Makefile
	@echo "âœ… æ‰“åŒ…å®Œæˆ: releases/github-actions-ssh-guide-$(shell date +%Y%m%d).tar.gz"

# åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
release: package
	@echo "ğŸš€ åˆ›å»ºå‘å¸ƒç‰ˆæœ¬..."
	@echo "ç‰ˆæœ¬ä¿¡æ¯:" > RELEASE_NOTES.md
	@echo "- ç”Ÿæˆæ—¶é—´: $(shell date)" >> RELEASE_NOTES.md
	@echo "- Git æäº¤: $(shell git rev-parse --short HEAD 2>/dev/null || echo 'unknown')" >> RELEASE_NOTES.md
	@echo "- åŒ…å«æ–‡æ¡£: GitHub Actions SSH ä½¿ç”¨æŒ‡å—" >> RELEASE_NOTES.md
	@echo "- æ ¼å¼: PDF, HTML" >> RELEASE_NOTES.md
	@echo "âœ… å‘å¸ƒç‰ˆæœ¬åˆ›å»ºå®Œæˆ"

# å¼€å‘ç¯å¢ƒè®¾ç½®
dev-setup: install-deps
	@echo "ğŸ› ï¸ è®¾ç½®å¼€å‘ç¯å¢ƒ..."
	@pip3 install pre-commit black flake8 pytest
	@echo "âœ… å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

# ä»£ç æ ¼å¼åŒ–
format:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	@black $(SCRIPTS_DIR)/*.py
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

# ä»£ç æ£€æŸ¥
lint:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	@flake8 $(SCRIPTS_DIR)/*.py --max-line-length=88
	@echo "âœ… ä»£ç æ£€æŸ¥å®Œæˆ"

# è¿è¡Œæ‰€æœ‰æ£€æŸ¥
check: lint test
	@echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡"

# æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
info:
	@echo "ğŸ“Š é¡¹ç›®ä¿¡æ¯"
	@echo "============="
	@echo "é¡¹ç›®åç§°: GitHub Actions SSH ä½¿ç”¨æŒ‡å—"
	@echo "æè¿°: å®Œæ•´çš„ SSH å¯†é’¥é…ç½®ä¸è‡ªåŠ¨åŒ–éƒ¨ç½²æŒ‡å—"
	@echo ""
	@echo "ğŸ“ ç›®å½•ç»“æ„:"
	@find . -type f -name "*.md" -o -name "*.py" -o -name "*.sh" -o -name "*.yml" | head -20
	@echo ""
	@echo "ğŸ“„ æ–‡æ¡£ç»Ÿè®¡:"
	@echo "Markdown æ–‡ä»¶: $(shell find . -name "*.md" | wc -l)"
	@echo "Python è„šæœ¬: $(shell find . -name "*.py" | wc -l)"
	@echo "Shell è„šæœ¬: $(shell find . -name "*.sh" | wc -l)"
	@echo "GitHub Actions: $(shell find .github/workflows -name "*.yml" 2>/dev/null | wc -l)"

# æ˜¾ç¤ºçŠ¶æ€
status:
	@echo "ğŸ” é¡¹ç›®çŠ¶æ€"
	@echo "============"
	@echo "Python ç¯å¢ƒ:"
	@python3 --version 2>/dev/null || echo "  âŒ Python 3 æœªå®‰è£…"
	@pip3 --version 2>/dev/null || echo "  âŒ pip3 æœªå®‰è£…"
	@echo ""
	@echo "ä¾èµ–æ£€æŸ¥:"
	@python3 -c "import markdown; print('  âœ… markdown:', markdown.__version__)" 2>/dev/null || echo "  âŒ markdown æœªå®‰è£…"
	@python3 -c "import weasyprint; print('  âœ… weasyprint:', weasyprint.__version__)" 2>/dev/null || echo "  âŒ weasyprint æœªå®‰è£…"
	@echo ""
	@echo "è¾“å‡ºç›®å½•:"
	@if [ -d "$(OUTPUT_DIR)" ]; then echo "  âœ… $(OUTPUT_DIR) å­˜åœ¨"; else echo "  âŒ $(OUTPUT_DIR) ä¸å­˜åœ¨"; fi
	@echo ""
	@echo "ç”Ÿæˆçš„æ–‡ä»¶:"
	@find $(OUTPUT_DIR) -name "*.pdf" 2>/dev/null | wc -l | xargs echo "  PDF æ–‡ä»¶:"
	@find $(OUTPUT_DIR) -name "*.html" 2>/dev/null | wc -l | xargs echo "  HTML æ–‡ä»¶:"

# å¿«é€Ÿå¼€å§‹
quickstart:
	@echo "ğŸš€ å¿«é€Ÿå¼€å§‹æŒ‡å—"
	@echo "================"
	@echo ""
	@echo "1ï¸âƒ£ å®‰è£…ä¾èµ–:"
	@echo "   make install-deps"
	@echo ""
	@echo "2ï¸âƒ£ ç”Ÿæˆ PDF:"
	@echo "   make pdf"
	@echo ""
	@echo "3ï¸âƒ£ è®¾ç½® SSH å¯†é’¥:"
	@echo "   make setup"
	@echo ""
	@echo "4ï¸âƒ£ æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤:"
	@echo "   make help"

# ä¸€é”®éƒ¨ç½²
all: install pdf-compress
	@echo "ğŸ‰ ä¸€é”®éƒ¨ç½²å®Œæˆï¼"
	@echo ""
	@echo "ç”Ÿæˆçš„æ–‡ä»¶:"
	@ls -la $(OUTPUT_DIR)/*.pdf 2>/dev/null || echo "  æ²¡æœ‰ PDF æ–‡ä»¶"
	@echo ""
	@echo "ä¸‹ä¸€æ­¥ï¼š"
	@echo "  1. æŸ¥çœ‹ç”Ÿæˆçš„ PDF: $(OUTPUT_DIR)/"
	@echo "  2. è®¾ç½® SSH å¯†é’¥: make setup"
	@echo "  3. æŸ¥çœ‹å®Œæ•´æŒ‡å—: make help"