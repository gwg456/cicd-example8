# GitLab CI/CD é…ç½®æ–‡ä»¶
# è‡ªåŠ¨ç”Ÿæˆ PDF æ–‡æ¡£å¹¶å‘å¸ƒåˆ° GitLab Pages

stages:
  - install
  - build
  - test
  - deploy
  - release

variables:
  # Python ç‰ˆæœ¬
  PYTHON_VERSION: "3.11"
  # è¾“å‡ºç›®å½•
  OUTPUT_DIR: "public"
  # PDF ç›®å½•
  PDF_DIR: "pdfs"
  # é¡¹ç›®åç§°
  PROJECT_NAME: "GitHub Actions SSH ä½¿ç”¨æŒ‡å—"

# ç¼“å­˜é…ç½®
cache:
  paths:
    - .cache/pip
    - venv/

# å®‰è£…ä¾èµ–
install-dependencies:
  stage: install
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - apt-get update
    - apt-get install -y 
        build-essential 
        libcairo2-dev 
        libpango1.0-dev 
        libgdk-pixbuf2.0-dev 
        libffi-dev 
        shared-mime-info 
        ghostscript 
        fonts-noto-cjk 
        fonts-noto-color-emoji
        curl
        git
  script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip list
  artifacts:
    paths:
      - venv/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

# ç”Ÿæˆ PDF æ–‡æ¡£
generate-pdf:
  stage: build
  image: python:${PYTHON_VERSION}-slim
  dependencies:
    - install-dependencies
  before_script:
    - apt-get update
    - apt-get install -y 
        libcairo2-dev 
        libpango1.0-dev 
        libgdk-pixbuf2.0-dev 
        libffi-dev 
        ghostscript
        fonts-noto-cjk
  script:
    - source venv/bin/activate
    - echo "ğŸ”„ å¼€å§‹ç”Ÿæˆ PDF æ–‡æ¡£..."
    
    # åˆ›å»ºè¾“å‡ºç›®å½•
    - mkdir -p ${OUTPUT_DIR}/${PDF_DIR}
    
    # ç”Ÿæˆä¸»è¦ PDF æ–‡æ¡£
    - python3 scripts/generate-pdf.py README.md -o "${OUTPUT_DIR}/${PDF_DIR}/GitHub-Actions-SSH-æŒ‡å—.pdf"
    
    # æ‰¹é‡ç”Ÿæˆæ‰€æœ‰ Markdown æ–‡ä»¶çš„ PDF
    - find . -name "*.md" -not -path "./venv/*" -not -path "./.git/*" | while read -r md_file; do
        filename=$(basename "$md_file" .md)
        echo "ç”Ÿæˆ PDF: $md_file -> ${filename}.pdf"
        python3 scripts/generate-pdf.py "$md_file" -o "${OUTPUT_DIR}/${PDF_DIR}/${filename}.pdf" || echo "è·³è¿‡: $md_file"
      done
    
    # ç”Ÿæˆ HTML ç‰ˆæœ¬
    - mkdir -p ${OUTPUT_DIR}/html
    - python3 -c "
import markdown
import os
from datetime import datetime

# è¯»å– README
with open('README.md', 'r', encoding='utf-8') as f:
    content = f.read()

# è½¬æ¢ä¸º HTML
md = markdown.Markdown(extensions=['codehilite', 'fenced_code', 'tables', 'toc', 'attr_list'])
html_content = md.convert(content)

# ç”Ÿæˆå®Œæ•´ HTML
full_html = f'''<!DOCTYPE html>
<html lang=\"zh-CN\">
<head>
    <meta charset=\"UTF-8\">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
    <title>GitHub Actions SSH ä½¿ç”¨æŒ‡å—</title>
    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css\">
    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css\">
    <style>
        .markdown-body {{ 
            box-sizing: border-box; 
            min-width: 200px; 
            max-width: 980px; 
            margin: 0 auto; 
            padding: 45px; 
        }}
        .footer {{
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e1e4e8;
            text-align: center;
            color: #586069;
            font-size: 14px;
        }}
    </style>
</head>
<body>
    <article class=\"markdown-body\">
        {html_content}
        <div class=\"footer\">
            <p>æ–‡æ¡£ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')}</p>
            <p>GitLab CI/CD è‡ªåŠ¨ç”Ÿæˆ</p>
        </div>
    </article>
</body>
</html>'''

# ä¿å­˜ HTML
with open('${OUTPUT_DIR}/html/index.html', 'w', encoding='utf-8') as f:
    f.write(full_html)
print('âœ… HTML æ–‡æ¡£ç”Ÿæˆå®Œæˆ')
"
    
    # ç”Ÿæˆæ–‡æ¡£ç´¢å¼•é¡µé¢
    - python3 -c "
import os
import json
from datetime import datetime

# è·å–æ‰€æœ‰ PDF æ–‡ä»¶
pdf_files = []
pdf_dir = '${OUTPUT_DIR}/${PDF_DIR}'
if os.path.exists(pdf_dir):
    for file in os.listdir(pdf_dir):
        if file.endswith('.pdf'):
            file_path = os.path.join(pdf_dir, file)
            file_size = os.path.getsize(file_path)
            pdf_files.append({
                'name': file.replace('.pdf', '').replace('-', ' '),
                'filename': file,
                'size': f'{file_size / 1024:.1f} KB',
                'path': f'${PDF_DIR}/{file}'
            })

# ç”Ÿæˆç´¢å¼•é¡µé¢
index_html = f'''<!DOCTYPE html>
<html lang=\"zh-CN\">
<head>
    <meta charset=\"UTF-8\">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
    <title>${PROJECT_NAME} - æ–‡æ¡£ä¸­å¿ƒ</title>
    <style>
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }}
        
        .header {{
            text-align: center;
            margin-bottom: 40px;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }}
        
        .header h1 {{
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }}
        
        .header p {{
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }}
        
        .stats {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }}
        
        .stat-card {{
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }}
        
        .stat-number {{
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }}
        
        .documents {{
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }}
        
        .doc-card {{
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }}
        
        .doc-card:hover {{
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }}
        
        .doc-title {{
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }}
        
        .doc-meta {{
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 15px;
        }}
        
        .doc-actions {{
            display: flex;
            gap: 10px;
        }}
        
        .btn {{
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
            flex: 1;
            text-align: center;
        }}
        
        .btn-primary {{
            background-color: #667eea;
            color: white;
        }}
        
        .btn-primary:hover {{
            background-color: #5a6fd8;
        }}
        
        .btn-secondary {{
            background-color: #95a5a6;
            color: white;
        }}
        
        .btn-secondary:hover {{
            background-color: #7f8c8d;
        }}
        
        .footer {{
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            color: #7f8c8d;
        }}
        
        .navigation {{
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }}
        
        .nav-links {{
            display: flex;
            gap: 20px;
            justify-content: center;
        }}
        
        .nav-link {{
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }}
        
        .nav-link:hover {{
            text-decoration: underline;
        }}
    </style>
</head>
<body>
    <div class=\"header\">
        <h1>ğŸ“š ${PROJECT_NAME}</h1>
        <p>å®Œæ•´çš„ SSH å¯†é’¥é…ç½®ä¸è‡ªåŠ¨åŒ–éƒ¨ç½²æŒ‡å—</p>
    </div>
    
    <div class=\"navigation\">
        <div class=\"nav-links\">
            <a href=\"html/index.html\" class=\"nav-link\">ğŸ“– åœ¨çº¿é˜…è¯»</a>
            <a href=\"#documents\" class=\"nav-link\">ğŸ“„ PDF ä¸‹è½½</a>
            <a href=\"https://gitlab.com/your-username/your-project\" class=\"nav-link\">ğŸ”— æºç ä»“åº“</a>
        </div>
    </div>
    
    <div class=\"stats\">
        <div class=\"stat-card\">
            <div class=\"stat-number\">{len(pdf_files)}</div>
            <div>PDF æ–‡æ¡£</div>
        </div>
        <div class=\"stat-card\">
            <div class=\"stat-number\">{sum(float(f['size'].replace(' KB', '')) for f in pdf_files):.0f}</div>
            <div>æ€»å¤§å° (KB)</div>
        </div>
        <div class=\"stat-card\">
            <div class=\"stat-number\">{datetime.now().strftime('%m-%d')}</div>
            <div>æ›´æ–°æ—¥æœŸ</div>
        </div>
    </div>
    
    <h2 id=\"documents\">ğŸ“„ æ–‡æ¡£ä¸‹è½½</h2>
    <div class=\"documents\">'''

for pdf in pdf_files:
    index_html += f'''
        <div class=\"doc-card\">
            <div class=\"doc-title\">{pdf['name']}</div>
            <div class=\"doc-meta\">ğŸ“¦ {pdf['size']} â€¢ PDF æ ¼å¼</div>
            <div class=\"doc-actions\">
                <a href=\"{pdf['path']}\" class=\"btn btn-primary\" target=\"_blank\">ğŸ“– é¢„è§ˆ</a>
                <a href=\"{pdf['path']}\" class=\"btn btn-secondary\" download>ğŸ’¾ ä¸‹è½½</a>
            </div>
        </div>'''

index_html += f'''
    </div>
    
    <div class=\"footer\">
        <p>ğŸ“… æ–‡æ¡£ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')}</p>
        <p>ğŸ¤– GitLab CI/CD è‡ªåŠ¨ç”Ÿæˆ â€¢ ç‰ˆæœ¬: {os.environ.get('CI_COMMIT_SHORT_SHA', 'unknown')}</p>
    </div>
</body>
</html>'''

# ä¿å­˜ç´¢å¼•é¡µé¢
with open('${OUTPUT_DIR}/index.html', 'w', encoding='utf-8') as f:
    f.write(index_html)

print(f'âœ… ç´¢å¼•é¡µé¢ç”Ÿæˆå®Œæˆï¼ŒåŒ…å« {len(pdf_files)} ä¸ª PDF æ–‡æ¡£')
"
    
    # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶
    - echo "ğŸ“Š ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
    - find ${OUTPUT_DIR} -type f -name "*.pdf" -o -name "*.html" | sort
    - echo ""
    - echo "ğŸ“¦ æ–‡ä»¶å¤§å°ç»Ÿè®¡:"
    - du -sh ${OUTPUT_DIR}/*
    
  artifacts:
    paths:
      - ${OUTPUT_DIR}/
    expire_in: 1 week
    reports:
      # ç”Ÿæˆå·¥ä»¶æŠ¥å‘Š
      junit: ${OUTPUT_DIR}/test-results.xml
  only:
    - main
    - develop
    - merge_requests

# æµ‹è¯• PDF ç”Ÿæˆ
test-pdf-generation:
  stage: test
  image: python:${PYTHON_VERSION}-slim
  dependencies:
    - generate-pdf
  script:
    - echo "ğŸ§ª æµ‹è¯• PDF æ–‡ä»¶..."
    
    # æ£€æŸ¥ PDF æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    - |
      if [ ! -d "${OUTPUT_DIR}/${PDF_DIR}" ]; then
        echo "âŒ PDF ç›®å½•ä¸å­˜åœ¨"
        exit 1
      fi
    
    # æ£€æŸ¥ä¸»è¦ PDF æ–‡ä»¶
    - |
      if [ ! -f "${OUTPUT_DIR}/${PDF_DIR}/GitHub-Actions-SSH-æŒ‡å—.pdf" ]; then
        echo "âŒ ä¸»è¦ PDF æ–‡ä»¶ä¸å­˜åœ¨"
        exit 1
      fi
    
    # éªŒè¯ PDF æ–‡ä»¶ä¸ä¸ºç©º
    - |
      for pdf in ${OUTPUT_DIR}/${PDF_DIR}/*.pdf; do
        if [ -f "$pdf" ]; then
          size=$(stat -c%s "$pdf")
          if [ $size -lt 1024 ]; then
            echo "âŒ PDF æ–‡ä»¶å¤ªå°: $pdf ($size bytes)"
            exit 1
          else
            echo "âœ… PDF æ–‡ä»¶æ­£å¸¸: $(basename "$pdf") ($size bytes)"
          fi
        fi
      done
    
    # æ£€æŸ¥ HTML æ–‡ä»¶
    - |
      if [ ! -f "${OUTPUT_DIR}/index.html" ]; then
        echo "âŒ ç´¢å¼•é¡µé¢ä¸å­˜åœ¨"
        exit 1
      fi
    
    - echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"
  only:
    - main
    - develop
    - merge_requests

# éƒ¨ç½²åˆ° GitLab Pages
pages:
  stage: deploy
  dependencies:
    - generate-pdf
  script:
    - echo "ğŸš€ éƒ¨ç½²åˆ° GitLab Pages..."
    - echo "ğŸ“‚ éƒ¨ç½²ç›®å½•å†…å®¹:"
    - ls -la ${OUTPUT_DIR}/
  artifacts:
    paths:
      - public
  only:
    - main

# åˆ›å»º Release
create-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  dependencies:
    - generate-pdf
  script:
    - echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒç‰ˆæœ¬..."
    
    # ç”Ÿæˆå‘å¸ƒè¯´æ˜
    - |
      cat > release_notes.md << EOF
      # GitHub Actions SSH ä½¿ç”¨æŒ‡å— v${CI_COMMIT_SHORT_SHA}
      
      ## ğŸ“„ åŒ…å«æ–‡æ¡£
      EOF
    
    # æ·»åŠ  PDF æ–‡ä»¶åˆ—è¡¨åˆ°å‘å¸ƒè¯´æ˜
    - |
      echo "" >> release_notes.md
      echo "### PDF æ–‡æ¡£" >> release_notes.md
      for pdf in ${OUTPUT_DIR}/${PDF_DIR}/*.pdf; do
        if [ -f "$pdf" ]; then
          filename=$(basename "$pdf")
          size=$(stat -c%s "$pdf")
          echo "- ğŸ“„ $filename ($(echo "scale=1; $size/1024" | bc) KB)" >> release_notes.md
        fi
      done
    
    - |
      echo "" >> release_notes.md
      echo "## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> release_notes.md
      echo "- ğŸ•’ ç”Ÿæˆæ—¶é—´: $(date)" >> release_notes.md
      echo "- ğŸ”¨ æ„å»ºç‰ˆæœ¬: ${CI_COMMIT_SHORT_SHA}" >> release_notes.md
      echo "- ğŸ“¦ æ€»æ–‡ä»¶æ•°: $(find ${OUTPUT_DIR} -name "*.pdf" | wc -l) ä¸ª PDF" >> release_notes.md
      echo "- ğŸ’¾ æ€»å¤§å°: $(du -sh ${OUTPUT_DIR} | cut -f1)" >> release_notes.md
    
    - cat release_notes.md
    
  release:
    name: 'GitHub Actions SSH æŒ‡å— v$CI_COMMIT_SHORT_SHA'
    description: release_notes.md
    tag_name: 'v$CI_COMMIT_SHORT_SHA'
    assets:
      links:
        - name: 'ğŸ“š åœ¨çº¿æ–‡æ¡£'
          url: '$CI_PAGES_URL'
        - name: 'ğŸ“„ PDF ä¸‹è½½'
          url: '$CI_PAGES_URL/pdfs/GitHub-Actions-SSH-æŒ‡å—.pdf'
  only:
    - main
  when: manual

# æ¸…ç†æ—§çš„å·¥ä»¶
cleanup:
  stage: release
  script:
    - echo "ğŸ§¹ æ¸…ç†å®Œæˆ"
  after_script:
    - echo "æ¸…ç†æ—§çš„ artifacts å’Œç¼“å­˜"
  only:
    - schedules
  when: manual